@page "/SEM"
@using SEMStandard;

<h1>Song Evolution Model</h1>
<hr>

<div style="width:900px">
    <div class='container'>
        <div class='container'>
            <div style="float:left;width:250px;">
                <b>Learning Strategy</b><br/>
                <input type = "radio" name="LearnStrat" value="Add" checked="@(LearnStrat == "Add")" onchange="@(() => SetLearning("Add"))" />Add<br/>
                <input type = "radio" name="LearnStrat" value="AddForget" checked="@(LearnStrat == "AddForget")" onchange="@(() => SetLearning("AddForget"))" />AddForget<br/>
                <input type = "radio" name="LearnStrat" value="AddConsensus" checked="@(LearnStrat == "Consensus")" onchange="@(() => SetLearning("Consensus"))" />Consensus<br/>
                <input type = "radio" name="LearnStrat" value="No Oblique" checked="@(Oblique == false)" onchange="@(() => SetLearning("NoOblique"))" />No Oblique<br/>
                <br/>
                <div class="slidecontainer"> 
                    <b>Consensus Tutors</b><br/>
                    <input bind="@NoTut" type="range" min="2" max="12" step="1" class="slider" disabled="@ConTutDisabled" /> @NoTut        
                </div>
            </div>
        </div> 
    </div>   

<div class='container'>
        <div style="float:left; width:250px;">
            <b>Repertoire Size</b><br />
            <div class="slidecontainer"> 
                <input bind="@RepSize" type="range" min="1" max="40" step="1" class="slider" />@RepSize
            </div>
        </div>

        <div style="float:left; width:250px;">
            <b>Repertoire Overhang</b><br />
            <div class="slidecontainer"> 
                <input bind="@RepOH" type="range" min="0" max="2" step=".01" class="slider" />@RepOH
            </div>
        </div>
        <br/>
        
        0
        <svg width="500" height="30">
            <rect width="500" height="30" style="fill:rgb(210,210,210);" />
            <rect width="@OH2()" height="30" style="fill:rgb(58,80,107);"/>
            <rect width="@OH1()" height="30" style="fill:rgb(108,145,194);" />
            <rect width="@RepSize" height="30" style="fill:rgb(0,0,0);"/>
        </svg>
        500
        <br />

        <div style="float:left; width:30px;">
            <svg width="50" height="90">
                <rect y="4" width="20" height="20" style="fill:rgb(0,0,0);" />
                <rect y="26" width="20" height="20" style="fill:rgb(108,145,194);" />
                <rect y="48" width="20" height="20" style="fill:rgb(58,80,107);" />              
                <rect y="70" width="20" height="20" style="fill:rgb(210,210,210);" />
            </svg>
        </div>
        <div style="float:left; width:250px;">
            90% chance to know <br/>
            10% chance to know <br/>
            1% chance to know <br/>
            0% chance to know <br/>
        </div>
    </div>
    <div style="clear: both;"></div>

    <br/><hr>

    
    <div class="container">
        <b>Preference</b><br/>
        <div class="slidecontainer">
            Template Matching (@MatFormat())
            <input bind="@RepPref" type="range" min="0" max="1" step=".01" class="slider"/>
            Larger Repertoire (@RepFormat())
        </div>
    </div>
    <br/>
    <hr>


    <div class='container'>
        <div style="float:left; width:250px;">
            <b>Accuracy</b>
            <div class="slidecontainer"> 
                <label>Initial</label>
                <input bind="@initACC" type="range" min="0" max="1" step=".01" class="slider" /> @initACC        
                <br/>
                <label>Noise</label> 
                <input bind="@NoiseACC" type="range" min="0" max=".5" step=".01" class="slider" /> @NoiseACC    
            </div>
        </div>
        <div>
            <b>Learning Threshold</b>
            <div class="slidecontainer"> 
                <label>Initial</label>
                <input bind="@initLTH" type="range" min="0" max="@MaxAge" step=".25" class="slider" /> @initLTH        
                <br/>
                <label>Noise</label> 
                <input bind="@NoiseLTH" type="range" min="0" max="10" step=".25" class="slider" /> @NoiseLTH    
            </div>
        </div>
    </div>
    <div style="clear: both;"></div>
    <br/>

    <div class='container'>
        <div style="float:left; width:250px;">
            <b>Chance to Forget</b>
            <div class="slidecontainer"> 
                <label>Initial</label>
                <input bind="@initCTF" type="range" min="0" max="1" step=".01" class="slider" /> @initCTF        
                <br/>
                <label>Noise</label> 
                <input bind="@NoiseCTF" type="range" min="0" max=".5" step=".01" class="slider" /> @NoiseCTF    
            </div>
        </div>
        <div>
            <b>Chance to Invent</b>
            <div class="slidecontainer"> 
                <label>Initial</label>
                <input bind="@initCTI" type="range" min="0" max="1" step=".01" class="slider" /> @initCTI        
                <br/>
                <label>Noise</label> 
                <input bind="@NoiseCTI" type="range" min="0" max=".5" step=".01" class="slider" /> @NoiseCTI    
            </div>
        </div>
    </div>
    <div style="clear: both;"></div>
    <hr>
    
    <div class='container'>
        <div style="float:left; width:250px;">
            <b>Learning Penalty</b><br />
            <div class="slidecontainer"> 
                <input bind="@LPen" type="range" min="0" max="5" step=".01" class="slider" />@LPen
            </div>
        </div>
        <div style="float:left; width:250px;">
            <b>Chick Survival</b><br />
            <div class="slidecontainer"> 
                <input bind="@Chick" type="range" min=".1" max=".9" step=".01" class="slider" />@Chick
            </div>
        </div>
        <div style="clear: both;"></div>

        <div style="float:left; width:250px;">
            <b>Encounter Success</b><br />
            <div class="slidecontainer"> 
                <input bind="@EnSuc" type="range" min="0" max="1" step=".01" class="slider" />@EnSuc
            </div>
        </div>
        <div style="float:left; width:250px;">
            <b>Maximum Age</b><br />
            <div class="slidecontainer"> 
                <input bind="@MaxAge" type="range" min="5" max="35" step="1" class="slider" />@MaxAge
            </div>
        </div>
        <div style="clear: both;"></div>
        <br/>

        <div>
            <b>Listening Threshold</b>
            <div class="slidecontainer"> 
                <label>Number of Syllables <b>Or</b> Percentage of Repertoire</label><br/>
                <input bind="@LisThrsh" type="range" min="1" max="7" step="1" class="slider" />
                &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                <input bind="@LisThrsh" type="range" min="0" max=".999" step=".01" class="slider" /> @LisThrsh    
                <br/>
            </div>
        </div>
    </div>
    <div style="clear: both;"></div>
    <hr>

    <div class='container' style="height=680px">
        <div style="float:left;width:250px;height:500px">
            <img src="/Images/Chicka1.png"/>
            <br/>
            <button onclick="@SetParam">Set Parameters</button><br/>
            <svg width="250" height="10">
                <rect width="250" height="1" y="5" style="fill:rgb(0,0,0);" />
            </svg>
            <b>Params: </b> @ParStatus<br/>
            <b>Timestep: </b> @CurrentStep <br/>
            <b>Status: </b>@Status<br/>
            <svg width="250" height="10">
                <rect width="250" height="1" y="5" style="fill:rgb(0,0,0);" />
            </svg>
            
            <b>Autoplay: </b>
            <button onclick="@AutoPlay" disabled ="@(@NotReady || !@NotRunning)">Start</button>
            <button onclick="@ResetRunning" disabled ="@(@NotReady || @NotRunning)">Stop</button><br/>
            <svg width="250" height="10">
                <rect width="250" height="1" y="5" style="fill:rgb(0,0,0);" />
            </svg>

            <button onclick="@(() => RunSimulation(Incre))" disabled ="@(@NotReady || !@NotRunning)">Next Steps</button><br/>
            <label>Timestep Increment:</label>
            <div class="slidecontainer"> 
                <input bind="@Incre" type="range" min="0" max="100" step="1" class="slider" />@Incre
            </div>
            <svg width="250" height="10">
                <rect width="250" height="1" y="5" style="fill:rgb(0,0,0);" />
            </svg>
            
            <b>Average Rep:</b> @AverageRep<br/>
            <b>Average Match:</b> @AverageMatch<br/>
            <b>Average Acc:</b> @AverageAcc<br/>
            <b>Average LrnTh:</b> @AverageLrnTh<br/>
            <b>Average CtI:</b> @AverageCtI<br/>
            <b>Average CtF:</b> @AverageCtF<br/>
            <svg width="250" height="10">
                <rect width="250" height="1" y="5" style="fill:rgb(0,0,0);" />
            </svg>
        </div>
        <div style="float:left;width:602px;height:700px;">
            <div style="width:602px;height:37px;">
                <input type = "radio" name="ColorPlot" value="SyllableRep" checked="@(TableCol == 1)" onchange="@(() => QuickSwitch(1))" disabled ="@NotReady" />Syllable Rep&nbsp;&nbsp;
                <input type = "radio" name="ColorPlot" value="Match" checked="@(TableCol == 2)" onchange="@(() => QuickSwitch(2))" disabled ="@(@NotReady || @NoMatch)" />Match&nbsp;&nbsp;
                <input type = "radio" name="ColorPlot" value="Accuracy" checked="@(TableCol == 3)" onchange="@(() => QuickSwitch(3))" disabled ="@NotReady" />Accuracy&nbsp;&nbsp;
                <input type = "radio" name="ColorPlot" value="LrnThresh" checked="@(TableCol == 4)" onchange="@(() => QuickSwitch(4))" disabled ="@NotReady" />Learning Threshold<br/>
            </div>
            <div style="width:602px;height:602px;border: 1px solid black">
                <table id="BirdMatrix">
                    <tr><td>Not Yet Initialized!</td></tr>
                </table>
            </div>
        </div>
    </div>
    <div style="clear: both;"></div>
    <br/><hr>
</div>


@functions {

    string ParStatus="None Set";
    int ParCount=0;
    int TableCol=1;
    bool ConTutDisabled=true;
    //bool StepsDisabled=true;
    bool NotReady=true;
    bool NoMatch=true;
    bool NotRunning=true;

    //bool ScopeB=false;
    //bool ScopeT=false;
    int MaxAge=20;
    int RepSize=5;
    int NoTut=8;
    int LSteps=1;
    double LisThrsh=7;
    double EnSuc=.95;
    double Chick=.3;
    double LPen=.75;
    double RepOH=.25;
    double initACC=.7;
    double NoiseACC=.15;
    double initLTH=2;
    double NoiseLTH=.25;
    double initCTI=.1;
    double NoiseCTI=0;
    double initCTF=.2;
    double NoiseCTF=0;
    double RepPref=1;
    string LearnStrat="Add";
    bool Oblique = true;

    Nullable<float> AverageRep=null;
    Nullable<float> AverageAcc=null;
    Nullable<float> AverageLrnTh=null;
    Nullable<float> AverageMatch=null;
    Nullable<float> AverageCtI=null;
    Nullable<float> AverageCtF=null;

    SimParams Par=new SimParams();
    Population Pop;
    int Incre=10;
    int CurrentStep=0;
    string Status="Not Running";

    string MatFormat(){
        return(String.Format("{0:0.00}",1-RepPref));
    }
    string RepFormat(){
        return(String.Format("{0:0.00}",RepPref));
    }
    void ResetRunning(){
        NotRunning=true;
    }
    int OH1(){
        return(RepSize+Convert.ToInt32(RepSize*RepOH));
    }
    int OH2(){
        return(RepSize+Convert.ToInt32(RepSize*RepOH)*2);
    }
    void SetLearning(string value){
        if(value == "NoOblique"){
            Oblique = false;
            ConTutDisabled=true;
        }else{
        LearnStrat=value;
        Oblique = true;
        if(value == "Consensus"){
            ConTutDisabled=false;
        }else{
            ConTutDisabled=true;
        }

        }
    }

    /*void SetLocal(bool breed, bool value){
        if(breed){
            ScopeB=value;
        }else{
            ScopeT=value;
        }
        if(ScopeT == true || ScopeB == true){
            StepsDisabled=false;
        }else{
            StepsDisabled=true;
        }
    }*/
    

    async void SetParam(){
        ParStatus="Generating!";
        NotRunning=true;
        await Task.Run(StateHasChanged);
        if(initLTH > MaxAge){
            initLTH = MaxAge;
        }
        Par=new SimParams(maxAge:MaxAge, //localBreeding:ScopeB, localTutor:ScopeT,
        initialSyllableRepertoireSize:RepSize,numTutorConsensusStrategy:NoTut,
        steps:LSteps,listeningThreshold:(float)LisThrsh,encounterSuccess:(float)EnSuc,
        chickSurvival:(float)Chick,learningPenalty:(float)LPen,
        percentSyllableOverhang:(float)RepOH,initialAccuracy:(float)initACC,
        inheritedAccuracyNoise:(float)NoiseACC,
        initialLearningThreshold:(float)initLTH,
        inheritedLearningThresholdNoise:(float)NoiseLTH,
        initialChancetoInvent:(float)initCTI,
        inheritedChancetoInventNoise:(float)NoiseCTI,
        initialChancetoForget:(float)initCTF, learningStrategy:LearnStrat,
        inheritedChancetoForgetNoise:(float)NoiseCTF, obliqueLearning:Oblique,
        matchPreference:(float)(1-RepPref),repertoireSizePreference:(float)RepPref);
        Pop=new Population(Par);
        AssignAves();
        ParCount+=1;
        CurrentStep=0;
        NotReady=false;
        await PromptInterop.BirdMatrixUpdate(Pop.Age, SetColors(TableCol, Pop));
        ParStatus=string.Format("{0}",ParCount);
        if(Par.MatchPreference > 0){
            NoMatch=false;
        }else{
            NoMatch=true;
        }
        StateHasChanged();
    }
    async void AutoPlay(){
        NotRunning=false;
        while(!NotRunning){
            RunSimulation(1, false);
            await Task.Delay(100);
        }
        this.Status="Not Running";
        StateHasChanged();
    }
    async void RunSimulation(int inc, bool stepped=true){
        this.Status="Running";
        for(int i=0;i<inc;i++){
            this.Pop=Simulations.WebSim(this.Par,this.Pop,1);
            this.CurrentStep+=1;
            StateHasChanged();
            await Task.Delay(5);
        }
        if(stepped){
            this.Status="Not Running";
        }
        AssignAves();
        await PromptInterop.BirdMatrixUpdate(this.Pop.Age, SetColors(this.TableCol, this.Pop));
        StateHasChanged();
    } 

    void AssignAves(){
        this.AverageRep=(float)Pop.SyllableRepertoire.Average();
        this.AverageAcc=(float)Pop.Accuracy.Average();
        this.AverageLrnTh=(float)Pop.LearningThreshold.Average();
        this.AverageMatch=(float)Pop.Match.Average();
        this.AverageCtI=(float)Pop.ChanceInvent.Average();
        this.AverageCtF=(float)Pop.ChanceForget.Average();
    }

    string[] SetColors(int color, Population Pop){
        float[] VarNeeded;
        float MAX;
        float MIN;
        float BinSize;
        int Converted;
        string[] FinalColor;
        if(color == 1){
            VarNeeded = Array.ConvertAll(Pop.SyllableRepertoire, x => (float)x);
            MAX=VarNeeded.Max();
            if(MAX < 100){
                MAX = 100;
            }
        }else if(color == 2){
            VarNeeded = Pop.Match;
            MAX=1;
        }else if(color==3){
            VarNeeded = Pop.Accuracy;
            MAX=1;
        }else{
            VarNeeded = Pop.LearningThreshold;
            MAX=Par.MaxAge;
        }
        MIN=0;
        BinSize=(MAX-MIN)/15;
        
        FinalColor = new string[VarNeeded.Length];
        for(int i=0;i<VarNeeded.Length;i++){
            Converted = 255-(int)((((int)((VarNeeded[i]-MIN)/BinSize))/15f)*255);
            FinalColor[i] = string.Format("rgb({0},{1},{2})", 255,Converted,Converted);
        }
        return(FinalColor);
    }
    async void QuickSwitch(int type){
        this.TableCol = type;
        await PromptInterop.BirdMatrixUpdate(Pop.Age, SetColors(TableCol, Pop));
    }
}
